then averaged, reducing the influence of individual poisoned fragments. Since the poisons are not optimized to dominate the mean of multiple embeddings, their effectiveness naturally decreases. Designing adaptive poisons to counteract this is difficult: it would require crafting embeddings with unusually large norms, which is hard to achieve in practice and can be mitigated by anomaly detection in embedding space. This distinction between the naive combination method and RAGPart is illustrated with a toy example usingN=3andk=2in Figure 2. 3.2. Defense: RAGMask The idea of RAGMask takes inspiration from perturbation-based defenses. The idea behind perturbation-based defenses Yang et al. (2021) is to analyze the behavior of a given sample in the presence of perturbations and make decisions accordingly. In the case of RAG, if the addition of a poison to a document makes it retrievable, then masking or occluding that token should cause a substantial drop in the similarity score between the document and the intended query. We leverage this insight to design the RAGMask defense, as shown in Figure 3, in the following way. Given a corpus of documentsD and a queryq, we first convert them into embeddings using the retriever model. We then retrieve the topαp documents, where α>1 . Assume that the length of a single document is li tokens. Each document has an initial similarity scorev q i with respect to the query. For each of the topαp documents, we divide the document intoli m segments, wherem is a predefined hyperparameter representing the mask length. We mask the document at each of theseli m positions and recompute the similarity score between the query and the masked version of the document, denoted byv q i ′ . If v q i ′ +δ>v q i, we keep the masked tokens in the document; otherwise, we discard them. Afterli